# CLAUDE.md — リポジトリ作業ガイドライン

> このファイルは Claude Code がこのリポジトリで作業する際に**常に参照する**ルール定義である。
> すべての指示は**厳守**すること。判断に迷った場合はこのファイルに立ち戻る。

---

## プロジェクト概要

- **目的**: テスト・学習用リポジトリ
- **内容**: Gitチートシートなどの参考資料、およびWebアプリケーションの実装

---

## リポジトリ構成

```
/
├── memo/             # 参考資料（Gitチートシートなど）
├── notepad-app/      # メモ帳アプリ（Java Servlet + H2 + HTML/CSS/JS の3層構造）
│   ├── CLAUDE.md     # notepad-app固有のルール
│   └── docs/         # 仕様書・処理フロー図などのドキュメント
│       ├── spec.md           # 機能仕様書
│       ├── architecture.md   # アーキテクチャ図（AI参照用・Mermaid記法）
│       └── architecture.html # アーキテクチャ図（人間閲覧用・ビジュアル）
├── templates/        # ドキュメントテンプレート
│   ├── spec-template.md          # 仕様書テンプレート（第3層）
│   └── app-claude-template.md    # アプリCLAUDE.mdテンプレート（第2層）
├── CLAUDE.md         # 本ファイル（全体の作業ガイドライン）
└── README.md         # プロジェクト説明
```

---

## ドキュメント3層構造

> **目的**: ルールと仕様を適切に分離し、情報の肥大化によるAIの注意力分散を防ぐ。

本リポジトリでは、ドキュメントを以下の3層で管理する。

| 層 | ファイル | 内容 | 読み込みタイミング |
|---|---|---|---|
| **第1層: 全体ルール** | `/CLAUDE.md`（本ファイル） | 開発ワークフロー、コーディング規約、対話ルールなど**全アプリ共通のルール** | **常に読み込まれる** |
| **第2層: アプリ固有ルール** | `/<アプリ>/CLAUDE.md` | 技術スタック、制約、参照ドキュメントなど**そのアプリ固有の文脈** | **該当フォルダで作業時** |
| **第3層: 仕様書** | `/<アプリ>/docs/spec.md` | 機能要件、データモデル、API定義など**何を作るかの定義** | **明示的に参照時** |

### 各層に書くべき内容の判断基準

- 「どのアプリを作るときでも守るべきルール」 → **第1層**（本ファイル）
- 「このアプリでだけ守るべきルール・文脈」 → **第2層**（アプリCLAUDE.md）
- 「何を作るか・どう動くかの定義」 → **第3層**（仕様書）

```
# ✅ 正しい判断例
「インデントはスペース2つ」       → 第1層（全アプリ共通のコーディング規約）
「Spring Frameworkは使用しない」  → 第2層（特定アプリの制約）
「ユーザーはメモを作成・編集できる」→ 第3層（機能仕様）

# ❌ 誤った判断例
仕様書の内容をルートCLAUDE.mdに書く → 肥大化してルールが埋もれる
全アプリ共通のルールをアプリCLAUDE.mdに書く → 重複管理が発生する
```

### テンプレート

第2層・第3層のドキュメントは、`/templates/` 配下のテンプレートをコピーして作成する。

| テンプレート | パス | 用途 |
|---|---|---|
| アプリCLAUDE.mdテンプレート | `/templates/app-claude-template.md` | 第2層の新規作成時にコピー → `/<アプリ>/CLAUDE.md` |
| 仕様書テンプレート | `/templates/spec-template.md` | 第3層の新規作成時にコピー → `/<アプリ>/docs/spec.md` |

- テンプレート本体を**直接編集することは禁止**。必ずコピーしてから編集する
- テンプレートの `[ ]` 部分を具体的な内容に置き換える

---

## AIDD開発ワークフロー

> **目的**: AIが「いきなりコードを書く」ことを防ぎ、段階的・計画的に開発を進める。
> **すべての開発作業はこのフローに従う。フェーズの省略は禁止。**

### フェーズ一覧

| フェーズ | やること | 完了条件 | 成果物 |
|---|---|---|---|
| **1. 要件定義** | ユーザーの要望をヒアリングし、何を作るか明確にする | ユーザーが要件に合意 | なし（対話で合意） |
| **2. 仕様策定** | 機能仕様書を作成する | ユーザーが仕様書を承認 | `docs/spec.md` |
| **3. 設計** | ディレクトリ構成・ファイル分割・技術選定を決定する | ユーザーが設計を承認 | アプリ `CLAUDE.md` + `docs/architecture.md` + `docs/architecture.html` |
| **4. 実装** | 仕様書に基づきコードを書く | 全機能が仕様通り動作 | ソースコード |
| **5. テスト・検証** | 動作確認し、問題があれば修正する | ユーザーが動作を確認 | テスト結果の報告 |
| **6. ドキュメント整備** | 仕様書・アーキテクチャ図・READMEを最終更新する | ドキュメントと実装が一致 | 更新済みドキュメント |

### フェーズの進め方

- **各フェーズの完了時に、必ずユーザーの承認を得てから次のフェーズに進む**
- ユーザーが明示的に「まとめて進めて」と指示した場合のみ、複数フェーズをまとめて実行してよい
- **フェーズ2（仕様策定）を完了する前に、フェーズ4（実装）に着手することは禁止**

```
# ✅ 正しいフロー
ユーザー: 「TODOアプリを作りたい」
Claude: 要件をヒアリング → 仕様書を作成 → ユーザー承認 → 設計 → ユーザー承認 → 実装

# ❌ 誤ったフロー
ユーザー: 「TODOアプリを作りたい」
Claude: いきなりコードを書き始める
```

---

## 仕様書管理ルール

> **目的**: 仕様書を統一された形式で管理し、AIが正確に参照・実装できるようにする。

### 配置ルール

- **配置場所**: `<アプリフォルダ>/docs/spec.md`
- 1アプリにつき1つの仕様書を原則とする
- 機能が多い場合は `docs/spec-<機能名>.md` で分割してよい（例: `spec-auth.md`, `spec-crud.md`）

### 仕様書の必須項目

仕様書には**必ず以下のすべての項目を含める**こと。項目の省略は禁止。

1. **機能概要** — この機能は何をするものか（1〜3行）
2. **要件一覧** — Must（必須）/ Nice to have（任意）に分類
3. **データモデル** — エンティティ、フィールド、型、制約
4. **API / エンドポイント** — メソッド、パス、リクエスト/レスポンス
5. **UI / 画面仕様** — 画面構成、操作フロー、表示ルール
6. **エラーハンドリング** — エラー条件とユーザーへの表示内容
7. **スコープ外** — 今回やらないことを明記
8. **完了条件** — 何をもって「この仕様は実装完了」とするか

### 仕様書テンプレート

新規作成時は `/templates/spec-template.md` をコピーして `<アプリフォルダ>/docs/spec.md` として配置し、内容を埋めること。

```
# ✅ 正しい手順
1. /templates/spec-template.md をコピー
2. /<アプリフォルダ>/docs/spec.md として配置
3. テンプレートの [ ] 部分を具体的な内容に置き換える

# ❌ 誤った手順
- テンプレートを使わずゼロから仕様書を書く → 必須項目の漏れが発生する
- テンプレート本体を直接編集する → 他のアプリで使えなくなる
```

### 仕様書と実装の同期（必須）

- 実装中に仕様変更が発生した場合、**コードと仕様書を同じコミットで更新**する
- 仕様書に書かれていない機能を実装することは**禁止**。先に仕様書を更新し、ユーザーの承認を得ること

---

## 実装ルール（AIDD固有）

> **目的**: AIの実装品質を安定させ、予期しない変更を防ぐ。

### 推測禁止

- 仕様書に記載のない要件について、**推測で実装することは禁止**
- 不明点がある場合は、**必ずユーザーに質問**してから実装する

```
# ✅ 正しい対応
「仕様書にはパスワードの最小文字数が記載されていません。何文字に設定しますか？」

# ❌ 誤った対応
（仕様書に記載がないが、8文字が一般的だろうと推測して実装する）
```

### 段階的実装

- **1回の実装単位は1機能（または1画面・1エンドポイント）まで**とする
- 複数機能を同時に実装することは禁止。1機能ずつ実装し、動作確認後に次へ進む

### 既存コード変更時のルール

- 既存のコードを変更する場合、**変更前に以下を報告**すること:
  - 変更対象のファイル一覧
  - 変更内容の概要
  - 影響範囲（他のファイル・機能への影響）
- ユーザーの承認を得てから変更を実行する

### 外部ライブラリ・依存関係

- 新たに外部ライブラリを導入する場合、**事前にユーザーに確認**する
- 確認時に以下を提示すること: ライブラリ名、用途、選定理由

---

## 対話・確認ルール

> **目的**: AIの自律的な判断範囲を明確にし、重要な判断はユーザーが行えるようにする。

### ユーザー承認が必須な操作

以下の操作は、**実行前に必ずユーザーの承認を得る**こと:

- ファイルの**削除**
- ディレクトリ構成の**変更**
- 外部ライブラリの**導入**
- 仕様書に記載のない機能の**追加**
- 設計上の重要な**判断**（アーキテクチャ、技術選定など）
- 既存コードの**大規模な変更**（リファクタリング含む）

### ユーザー承認なしで進めてよい操作

以下の操作は、承認なしで実行してよい:

- コーディングルールに基づく**フォーマット修正**
- 仕様書に明記された機能の**実装**
- コメントの**追加・修正**
- 明らかなバグの**修正**（修正内容は事後報告する）
- CLAUDE.md「リポジトリ構成」の**自動更新**

### 進捗報告

- 各機能の実装完了時に、**何を実装したか・何が残っているか**を報告する
- エラーや想定外の問題が発生した場合は、**即座に報告**する（自己判断で回避策を取らない）

### 大規模作業の事前計画

5ファイル以上の変更、または新規アプリ作成の場合、**作業前に計画を提示**すること:

- 作成/変更するファイルの一覧
- 作業の順序
- 想定される所要ステップ数

---

## 構成ルール

> **目的**: リポジトリの秩序を保ち、どこに何があるか常に追跡可能にする。

### 新規アプリ作成時

1. リポジトリ**直下**に専用フォルダを作成する（ネストしない）
2. ソースコード・設定ファイル・ドキュメントはすべてそのフォルダ内に格納する
3. `/templates/app-claude-template.md` をコピーし、アプリフォルダ直下に **`CLAUDE.md`** として配置・編集する
4. `/templates/spec-template.md` をコピーし、**`docs/spec.md`** として配置・編集する
5. ルートの `CLAUDE.md`「リポジトリ構成」を更新する

```
# ✅ 正しい配置
/todo-app/
  CLAUDE.md             # アプリ固有ルール
  docs/
    spec.md             # 仕様書
    architecture.md     # アーキテクチャ図（AI参照用・Mermaid記法）
    architecture.html   # アーキテクチャ図（人間閲覧用・ビジュアル）
  src/                  # ソースコード

# ❌ 誤った配置
/apps/todo-app/                       # ネスト禁止
/todo-app/（CLAUDE.mdなし）            # アプリCLAUDE.md必須
/todo-app/（docs/spec.mdなし）         # 仕様書必須
/todo-app/（architecture.mdのみ）      # htmlとセットで作成すること
/todo-app/（architecture.htmlのみ）    # mdとセットで作成すること
```

### CLAUDE.md の自動更新（必須）

以下の操作を行った場合、**同じコミット内で**本ファイルの「リポジトリ構成」セクションを更新すること:

- フォルダの追加・削除・リネーム
- ファイル構成の大幅な変更

### アーキテクチャドキュメント（必須）

アプリを**新規作成**または**大幅に変更**した場合、以下の**2ファイルをセットで**作成・更新する:

#### `architecture.md` — AI参照用（Mermaid記法）

- **配置場所**: `<アプリフォルダ>/docs/architecture.md`
- **目的**: AIがコード生成・修正時に参照する。トークン効率を優先し、情報を簡潔に記述する
- **必須コンテンツ**:
  - アーキテクチャ概要（3層構造などをMermaidの `graph` または `classDiagram` で記述）
  - 各操作（CRUD等）のリクエスト → 処理 → レスポンスのフロー（Mermaidの `sequenceDiagram` で記述）
  - ファイルと役割の対応表（Markdownテーブル形式）
- **記述ルール**: Mermaid記法を使用し、図はコードブロック内に記述する

```markdown
<!-- ✅ 正しい例 -->
## ログイン処理フロー

​```mermaid
sequenceDiagram
  Browser->>AuthFilter: POST /api/auth/login
  AuthFilter->>AuthServlet: 通過
  AuthServlet->>UserDao: findByUsername
  UserDao->>H2: SELECT FROM users
  H2-->>UserDao: ユーザーデータ
  UserDao-->>AuthServlet: Userオブジェクト
  AuthServlet-->>Browser: {success: true}
​```

<!-- ❌ 誤った例: フローをテキストのみで記述している -->
ブラウザからAuthFilterを経由してAuthServletに到達し、UserDaoがDBを検索する。
```

#### `architecture.html` — 人間閲覧用（ビジュアル）

- **配置場所**: `<アプリフォルダ>/docs/architecture.html`
- **目的**: ブラウザで開いて視覚的に確認するためのリファレンス資料
- **必須コンテンツ**:
  - アーキテクチャ概要図
  - 各操作（CRUD等）のリクエスト → 処理 → レスポンスのフロー
  - ファイルと役割の対応表
- **スタイル要件**: 各層・コンポーネントを**色分け**して視覚的に区別する

#### 2ファイルの内容同期（必須）

- `architecture.md` と `architecture.html` は**常に同じ内容を表現**すること
- どちらか一方を更新した場合、**同じコミットでもう一方も更新**する

---

## コーディングルール

> **目的**: プロジェクト全体でスタイルを統一し、可読性と保守性を確保する。

### 全言語共通（最優先）

| ルール | 詳細 |
|---|---|
| ファイル末尾 | **必ず改行を1つ**入れる |
| 末尾の空白 | **必ず削除**する |
| コメント言語 | **日本語**で記述する |

---

### HTML

- DOCTYPE: `<!DOCTYPE html>` を必ず記述する
- インデント: **スペース2つ**
- `<html>` タグに `lang` 属性を指定する（例: `lang="ja"`）
- タグ名・属性名は**小文字**で記述する
- 属性値は**ダブルクォート**で囲む
- セマンティックHTML要素を適切に使用する（`<header>`, `<main>`, `<section>`, `<article>`, `<footer>` など）

```html
<!-- ✅ 正しい例 -->
<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <title>タイトル</title>
  </head>
  <body>
    <header class="site-header">
      <h1>見出し</h1>
    </header>
    <main>
      <section class="content-area">
        <p>本文</p>
      </section>
    </main>
  </body>
</html>

<!-- ❌ 誤った例 -->
<HTML Lang='ja'>
<DIV class="header">
  <H1>見出し</H1>
</DIV>
```

---

### CSS

- インデント: **スペース2つ**
- クラス名: **ケバブケース**（`my-class-name`）
- セレクタ: **クラスセレクタを使用**する。IDセレクタ（`#id`）でのスタイリングは**禁止**
- プロパティ順序: **アルファベット順**に記述する
- 色の値: **小文字の16進数**（`#fff`, `#333333`）
- マジックナンバー: **禁止**。CSS変数（`var(--spacing-md)`）を使用する

```css
/* ✅ 正しい例 */
.content-card {
  background-color: #fff;
  border-radius: var(--radius-sm);
  color: #333;
  padding: var(--spacing-md);
}

/* ❌ 誤った例: IDセレクタ、マジックナンバー、順序不定、大文字色 */
#card {
  padding: 16px;
  color: #333;
  background-color: #FFF;
  border-radius: 4px;
}
```

---

### JavaScript

- インデント: **スペース2つ**
- 文字列: **シングルクォート**（`'文字列'`）
- 文末: **セミコロン必須**
- 変数宣言: `const` を優先 → 再代入が必要な場合のみ `let` を使用。**`var` は禁止**
- 比較演算子: **厳密等価**（`===`, `!==`）のみ使用。**`==`, `!=` は禁止**
- 関数: **アロー関数を優先**する
- 命名規則:
  - 変数・関数 → `camelCase`（例: `myVariable`, `getUserName`）
  - クラス → `PascalCase`（例: `UserService`）
  - 定数 → `UPPER_SNAKE_CASE`（例: `MAX_RETRY_COUNT`）

```javascript
// ✅ 正しい例
const MAX_RETRY_COUNT = 3;

const fetchUserData = async (userId) => {
  const response = await fetch(`/api/users/${userId}`);
  if (response.status === 200) {
    return response.json();
  }
  return null;
};

// ❌ 誤った例: var、==、ダブルクォート、function宣言
var maxRetry = 3;
function fetchUserData(userId) {
  var response = fetch("/api/users/" + userId);
  if (response.status == 200) {
    return response.json()
  }
}
```

---

### Java

- インデント: **スペース4つ**
- アクセス修飾子: **必ず明示**する（省略しない）
- クラス構成: **1クラス1ファイル**。ファイル名はクラス名と一致させる
- `@Override`: 該当するメソッドには**必ず付与**する
- 命名規則:
  - 変数・メソッド → `camelCase`（例: `userName`, `getUserName()`）
  - クラス → `PascalCase`（例: `NoteServlet`）
  - 定数 → `UPPER_SNAKE_CASE`（例: `MAX_COUNT`）
  - パッケージ → `all.lowercase`（例: `com.example.myapp`）

```java
// ✅ 正しい例
package com.example.notepad;

public class NoteServlet extends HttpServlet {

    private static final int MAX_COUNT = 100;

    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp)
            throws ServletException, IOException {
        // リクエストを処理する
    }
}

// ❌ 誤った例: アクセス修飾子省略、@Override欠落、命名違反
class noteServlet extends HttpServlet {
    static final int max_count = 100;

    void doGet(HttpServletRequest req, HttpServletResponse resp) {
    }
}
```

---

## 対話ルール

| ルール | 適用範囲 |
|---|---|
| **日本語**で対話する | Claudeとのすべてのやり取り |
| **日本語**で記述する | コミットメッセージ、ドキュメント、コードコメント |

---

## Markdownドキュメント記述ルール

> **目的**: CLAUDE.md・仕様書・READMEなどのMarkdownファイルを、AIが正確に解釈・実行できる形式で統一する。
> Markdownファイルの新規作成・編集時は、**必ず以下のルールに従う**こと。

### 文書構造

- **冒頭に文書の役割と重要度を明記**する。ファイルの最初に「このファイルは何か」「どの程度厳守すべきか」を1〜2行で宣言する

```markdown
<!-- ✅ 正しい例 -->
> このファイルは○○のルール定義である。すべての指示は**厳守**すること。

<!-- ❌ 誤った例: 役割や重要度が不明 -->
# メモ
いろいろなルールをまとめます。
```

- **見出し階層を正しく使う**。`#` → `##` → `###` の順に使用し、階層を飛ばさない

```markdown
<!-- ✅ 正しい例 -->
## セクション名
### サブセクション名

<!-- ❌ 誤った例: ##を飛ばしている -->
# セクション名
### サブセクション名
```

- **各セクションの冒頭に目的（なぜこのルールがあるか）を記載**する。`>` 引用ブロックで記述する

```markdown
<!-- ✅ 正しい例 -->
## コーディングルール
> **目的**: プロジェクト全体でスタイルを統一し、可読性を確保する。

<!-- ❌ 誤った例: 目的がなく、ルールの意図が不明 -->
## コーディングルール
- インデントはスペース2つ
```

- **セクション間は `---`（水平線）で区切る**

### ルールの記述方法

- **曖昧な表現は禁止**。「〜を避ける」「〜が望ましい」ではなく、「**〜は禁止**」「**〜は必須**」と断定する

```markdown
<!-- ✅ 正しい例 -->
- IDセレクタでのスタイリングは**禁止**
- `@Override` アノテーションは**必ず付与**する

<!-- ❌ 誤った例: 曖昧で判断に迷う -->
- IDセレクタはなるべく避ける
- `@Override` を付けることが望ましい
```

- **具体的な値・パス・コマンドを明記**する。抽象的な指示は禁止

```markdown
<!-- ✅ 正しい例 -->
- 配置場所: `<アプリフォルダ>/docs/architecture.md`
- インデント: **スペース4つ**

<!-- ❌ 誤った例: 具体性がない -->
- 適切な場所にドキュメントを配置する
- 適切なインデントを使用する
```

- **条件と動作をセットで書く**。「〜の場合は、〜すること」の形式にする

```markdown
<!-- ✅ 正しい例 -->
フォルダ構成を変更した場合、**同じコミット内で** CLAUDE.md の「リポジトリ構成」を更新すること

<!-- ❌ 誤った例: いつ実行すべきか不明 -->
CLAUDE.md は適宜更新する
```

### コード例の記載

- **✅正しい例と❌誤った例を必ず併記**する。片方だけでは不十分
- ❌の例には**何が誤りかをコメントで説明**する

````markdown
<!-- ✅ 正しい記載 -->
```javascript
// ✅ 正しい例
const userName = 'Alice';

// ❌ 誤った例: var使用、ダブルクォート
var userName = "Alice";
```

<!-- ❌ 誤った記載: 正しい例だけで、何を避けるべきか不明 -->
```javascript
const userName = 'Alice';
```
````

### 表・リストの使い分け

- **2項目以上の対応関係**がある場合は**表形式**を使用する

```markdown
<!-- ✅ 正しい例: 対応関係が明確 -->
| ルール | 詳細 |
|---|---|
| ファイル末尾 | **必ず改行を1つ**入れる |
| 末尾の空白 | **必ず削除**する |

<!-- ❌ 誤った例: 対応関係が散文に埋もれている -->
ファイルの末尾には改行を入れてください。また、末尾の空白は削除してください。
```

- **手順・順序がある場合は番号付きリスト**、**順序がない場合は箇条書き**を使用する

### チェックリスト

- **ファイル末尾に作業完了チェックリスト**を設ける。`- [ ]` 形式で、作業後の自己検証項目を列挙する

### ディレクトリ構成の記載

- **tree形式のコードブロック**で記述する。各項目に `#` コメントで説明を付ける

```markdown
<!-- ✅ 正しい例 -->
​```
/
├── src/          # ソースコード
│   ├── index.js  # エントリーポイント
│   └── utils/    # ユーティリティ
└── README.md     # プロジェクト説明
​```

<!-- ❌ 誤った例: 構造が読み取りにくい -->
- src/ にソースコードがあります
  - index.js がエントリーポイントです
  - utils/ にユーティリティがあります
```

---

## 作業完了チェックリスト

コード生成・ファイル変更を行った後、コミット前に以下を確認すること:

- [ ] AIDD開発ワークフローに従って作業したか（フェーズの省略はないか）
- [ ] 仕様書に記載のない機能を実装していないか
- [ ] コーディングルール（インデント、命名、禁止事項）に違反していないか
- [ ] ファイル末尾に改行があるか、末尾空白がないか
- [ ] コメント・ドキュメントが日本語で記述されているか
- [ ] フォルダ構成を変更した場合、CLAUDE.md の「リポジトリ構成」を更新したか
- [ ] アプリを新規作成・大幅変更した場合、`docs/architecture.md` を作成・更新したか
- [ ] アプリを新規作成・大幅変更した場合、`docs/architecture.html` を作成・更新したか
- [ ] `architecture.md` と `architecture.html` の内容が一致しているか
- [ ] 仕様変更があった場合、`docs/spec.md` を同じコミットで更新したか
- [ ] Markdownファイルを作成・編集した場合、「Markdownドキュメント記述ルール」に従っているか